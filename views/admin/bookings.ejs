<!DOCTYPE html>
<html>
<head>
    <title>Admin - Booking Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Your Global CSS -->
    <link rel="stylesheet" href="/css/admin.css">
</head>

<body>

<%- include('../partials/adminNavbar') %>

<div class="container mt-5">

    <h3 class="booking-title">Booking Management</h3>

    <!-- ðŸ” Search + Filter -->
    <div class="row filter-row">
        <div class="col-md-4">
            <input type="text" id="searchInput"
                   class="form-control"
                   placeholder="Search faculty or destination...">
        </div>

        <div class="col-md-3">
            <select id="statusFilter" class="form-select">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="completed">Completed</option>
            </select>
        </div>
    </div>

    <% if (bookings.length === 0) { %>

        <div class="alert alert-info">
            No bookings available.
        </div>

    <% } else { %>

    <table class="table table-bordered table-hover align-middle">

        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Faculty</th>
                <th>Destination</th>
                <th>Date</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody>

        <% bookings.forEach(b => { %>

            <tr id="row-<%= b.id %>">

                <td><%= b.id %></td>

                <td><%= b.name %></td>

                <td><%= b.destination %></td>

                <td>
                    <% 
                        const d = new Date(b.date);
                        const formatted =
                            d.getDate().toString().padStart(2,'0') + '/' +
                            (d.getMonth()+1).toString().padStart(2,'0') + '/' +
                            d.getFullYear();
                    %>
                    <%= formatted %>
                </td>

                <td id="status-<%= b.id %>">
                    <span class="badge 
                        <%= b.status === 'approved' ? 'bg-success' : 
                            b.status === 'pending' ? 'bg-warning text-dark' : 
                            b.status === 'completed' ? 'bg-primary' :
                            'bg-secondary' %>">
                        <%= b.status %>
                    </span>
                </td>

                <td>
                    <% if (b.status === 'pending') { %>
                        <button class="btn btn-success btn-sm"
                                onclick="approveBooking('<%= b.id %>')">
                            Approve
                        </button>
                    <% } else { %>
                        â€”
                    <% } %>
                </td>

            </tr>

        <% }) %>

        </tbody>
    </table>

    <% } %>

</div>

<script>

/* =========================
   ðŸ” SEARCH FUNCTION
========================= */
document.getElementById("searchInput").addEventListener("keyup", function() {

    const value = this.value.toLowerCase();
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(value) ? "" : "none";
    });
});


/* =========================
   ðŸ“‚ STATUS FILTER
========================= */
document.getElementById("statusFilter").addEventListener("change", function() {

    const value = this.value.toLowerCase();
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach(row => {
        const status = row.querySelector("td:nth-child(5)").innerText.toLowerCase();

        if (!value || status.includes(value)) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
});


/* =========================
   âœ… APPROVE BOOKING
========================= */
function approveBooking(id) {

    if (!confirm("Are you sure you want to approve this booking?")) return;

    fetch(`/bookings/approve/${id}`, {
        method: 'PUT'
    })
    .then(res => res.json())
    .then(data => {

        const statusCell = document.getElementById(`status-${id}`);
        statusCell.innerHTML = '<span class="badge bg-success">approved</span>';

        const row = document.getElementById(`row-${id}`);
        const button = row.querySelector('button');
        if (button) button.remove();

    })
    .catch(err => console.error("Error:", err));
}

</script>

</body>
</html>